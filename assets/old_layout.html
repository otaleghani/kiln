<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Note, base or canvas -->
    {{ if and (not .IsFolder) (not .IsTag) }}
      <title>
        {{ if .Frontmatter.title }}
          {{ .Frontmatter.title }}
        {{ else }}
          {{ .File.Name }}
        {{ end }}
        ‚Ä¢
        {{ .Site.SiteName }}
      </title>
      <meta
        name="description"
        content="{{ if .Frontmatter.description }}
          {{ .Frontmatter.description }}
        {{ else }}
          Notes on
          {{ .File.Name }}
        {{ end }}"
      />
      <meta property="og:title" content="{{ .File.Name }}" />
    {{ end }}
    <!-- Folder -->
    {{ if .IsFolder }}
      <title>{{ .Folder.RelPath }} ‚Ä¢ {{ .Site.SiteName }}</title>
      <meta name="description" content="{{ .Folder.RelPath }}" />
      <meta property="og:title" content="{{ .Folder.RelPath }}" />
    {{ end }}
    <meta name="generator" content="Kiln" />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://d3js.org" />
    <link rel="preload" href="{{ .Site.BaseURL }}/style.css" as="style" />
    <link rel="stylesheet" href="{{ .Site.BaseURL }}/style.css" />
    <script>
      (function () {
        try {
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme) {
            document.documentElement.setAttribute("data-theme", savedTheme);
          }
        } catch (e) {}
      })();
    </script>
    <!--   <style> -->
    <!-- .sidebar { -->
    <!--   transition: none !important; -->
    <!-- } -->
    <!-- .sidebar.animate-ready { -->
    <!--   transition: margin 0.3s ease !important; -->
    <!-- } -->
    <!--   </style> -->
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    <script src="{{ .Site.BaseURL }}/graph.js" defer></script>
    <script src="{{ .Site.BaseURL }}/app.js" defer></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEscapes: true,
        },
        svg: { fontCache: "global" },
      };
    </script>
  </head>
  <body
    hx-boost="true"
    hx-select="#kiln-main"
    hx-target="#kiln-main"
    hx-swap="outerHTML"
  >
    <div class="layout" id="layout">
      <nav class="sidebar left-sidebar" id="sidebar">
        <script>
          try {
            if (localStorage.getItem("sidebar-collapsed") === "true")
              document.getElementById("sidebar").classList.add("collapsed");
          } catch (e) {}
        </script>
        <div class="sidebar-header">
          <a class="sidebar-home-link" href="{{ .Site.BaseURL }}/"
            >{{ .Site.SiteName }}</a
          >
          <div class="sidebar-actions">
            <button id="theme-toggle" aria-label="Toggle Theme">
              <i class="sun-icon" data-lucide="sun"></i>
              <i class="moon-icon" data-lucide="moon"></i>
            </button>
            {{ if and (.Site.DisableLocalGraph) (.Site.DisableTOC) }}
              <a
                href="{{ .Site.BaseURL }}/graph"
                class="graph-btn"
                title="Global Graph"
                ><i data-lucide="globe"></i
              ></a>
            {{ end }}
            <button
              class="sidebar-toggle left-toggle sidebar-toggle-navbar"
              aria-label="Toggle Sidebar"
            ></button>
          </div>
        </div>
        <div class="sidebar-content">
          <div
            class="sidebar-search-container"
            style="position: sticky;
                                top: 0;
                                background: var(--sidebar-bg);
                                z-index: 10;
                                margin-bottom: 8px"
          >
            <input
              type="text"
              id="sidebar-search"
              placeholder="Search notes..."
              style="width: 100%;
                                      padding: 0.5rem;
                                      border: 1px solid var(--sidebar-border);
                                      border-radius: 4px;
                                      background: var(--bg);
                                      color: var(--text)"
            />
          </div>
          <ul>
            {{ template "tree" .Site.NavbarRoot.Children }}
          </ul>
          <footer
            style="margin-top: 3rem;
                                   font-size: 0.8rem;
                                   color: #888;
                                   text-align: center"
          >
            Generated with
            <a href="https://kiln.talesign.com" target="_blanc">Kiln</a> ‚Ä¢
            <a href="https://github.com/otaleghani/kiln" target="_blanc"
              >Github</a
            >
          </footer>
        </div>
      </nav>
      <div class="center-container">
        <main id="kiln-main" class="main-wrapper">
          {{ if and (not .IsFolder) (not .IsTag) }}
            <div
              id="page-title-data"
              data-title="{{ .File.WebPath }}"
              hidden
            ></div>
          {{ end }}
          {{ if .IsFolder }}
            <div
              id="page-title-data"
              data-title="{{ .Folder.WebPath }}"
              hidden
            ></div>
          {{ end }}
          {{ if .IsTag }}
            <div
              id="page-title-data"
              data-title="{{ .Tag.WebPath }}"
              hidden
            ></div>
          {{ end }}
          <div class="navbar">
            <button
              class="sidebar-toggle left-toggle"
              aria-label="Toggle Sidebar"
            >
              ‚ò∞
            </button>
            {{ if .Breadcrumbs }}
              {{ template "breadcrumbs" . }}
            {{ end }}
            {{ if or (not .Site.DisableLocalGraph) (not
              .Site.DisableTOC)
            }}
              <button
                class="sidebar-toggle right-toggle"
                aria-label="Toggle Right Sidebar"
              >
                ‚ò∞
              </button>
            {{ end }}
          </div>
          <div
            class="content-wrapper {{ if .IsCanvas }}
              canvas-mode
            {{ end }} {{ if .IsGraph }}canvas-mode{{ end }}"
          >
            {{ if .IsCanvas }}
              <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
              <script src="{{ .Site.BaseURL }}/canvas.js"></script>
              <div id="viewport">
                <div id="canvas-world">
                  <svg id="edges-layer"></svg>
                </div>
              </div>
              <div id="canvas-controls">
                <button
                  onclick="window.renderer.zoomOut()"
                  class="canvas-btn icon-minus"
                  aria-label="Zoom Out"
                ></button>
                <button
                  onclick="window.renderer.resetView()"
                  class="canvas-btn icon-maximize"
                  aria-label="Reset View"
                ></button>
                <button
                  onclick="window.renderer.zoomIn()"
                  class="canvas-btn icon-plus"
                  aria-label="Zoom In"
                ></button>
              </div>
                        <script>
              (function() {
                  var data = {{.CanvasContent}};
                  if (window.initCanvasMode) {
                      // Navigating via HTMX (App is already loaded)
                      window.initCanvasMode(data);
                  } else {
                      // F5 Refresh (App is 'defer' and hasn't loaded yet)
                      document.addEventListener('DOMContentLoaded', function() {
                          if (window.initCanvasMode) window.initCanvasMode(data);
                      });
                  }
              })();
                        </script>
            {{ else if .IsGraph }}
              {{ .Content }}
            {{ else if .IsNote }}
              <article class="content">
                <div class="markdown-body">{{ .Content }}</div>
              </article>
            {{ else if .IsBase }}
              {{ template "base" . }}
            {{ else if .IsFolder }}
              {{ template "folder" . }}
            {{ else if .IsTag }}
              {{ template "tag" . }}
            {{ end }}
            <script>
              if (window.initAll) window.initAll();
            </script>
          </div>
        </main>
      </div>
      {{ if or (not .Site.DisableLocalGraph) (not .Site.DisableTOC) }}
        <aside class="sidebar right-sidebar" id="right-sidebar">
          <script>
            try {
              if (localStorage.getItem("right-sidebar-collapsed") === "true")
                document
                  .getElementById("right-sidebar")
                  .classList.add("collapsed");
            } catch (e) {}
          </script>
          <div class="sidebar-header">
            <div class="sidebar-actions">
              <a
                href="{{ .Site.BaseURL }}/graph"
                class="graph-btn"
                title="Global Graph"
                ><i data-lucide="globe"></i
              ></a>
              <button
                class="sidebar-toggle right-toggle sidebar-toggle-navbar"
                aria-label="Toggle Sidebar"
              ></button>
            </div>
          </div>
          <div class="sidebar-content">
            {{ if not .Site.DisableLocalGraph }}
              <div id="local-graph-wrapper" class="local-graph-wrapper">
                <div class="graph-header">
                  <span class="sidebar-label">Local Graph</span>
                  <div class="graph-controls">
                    <button
                      class="graph-btn"
                      onclick="window.toggleGraphExpand()"
                      title="Expand"
                    >
                      <i data-lucide="maximize-2"></i>
                    </button>
                  </div>
                </div>
                <div id="local-graph-container"></div>
              </div>
            {{ end }}
            {{ if not .Site.DisableTOC }}
              <aside
                class="toc-container"
                id="toc-container"
                hx-swap-oob="true"
              >
                {{ if .TOC }}
                  <span class="sidebar-label">On this page</span>
                  {{ .TOC }}
                {{ end }}
              </aside>
            {{ end }}
          </div>
        </aside>
      {{ end }}
    </div>
  </body>
</html>
<!-- BASE -->
{{ define "base" }}
  {{ if eq (index .Base.File.Views 0).Type "table" }}
    {{ template "table" . }}
  {{ end }}
  {{ if eq (index .Base.File.Views 0).Type "cards" }}
    {{ template "cards" . }}
  {{ end }}
  {{ if eq (index .Base.File.Views 0).Type "list" }}
    {{ template "list" . }}
  {{ end }}
{{ end }}
<!-- Table -->
{{ define "table" }}
  <div class="obsidian-view-container">
    <div class="obsidian-table-view">
      <table>
        <thead>
          <tr>
            {{/* Table Headers (Always visible) */}}
            {{ range .Base.Columns }}
              <th>{{ getDisplayName $.Base.File . }}</th>
            {{ end }}
          </tr>
        </thead>
        <tbody>
          {{/* CASE 1: GROUPED VIEW */}}
          {{ if .Base.Groups }}
            {{ range $group := .Base.Groups }}
              {{/* The Group Header Row (Inside the table) */}}
              <tr class="group-row">
                <td colspan="{{ len $.Base.Columns }}">
                  {{ $group.Key }}
                  <span class="group-count">({{ len $group.Notes }})</span>
                </td>
              </tr>
              {{/* The Notes for this Group */}}
              {{ range $note := $group.Notes }}
                {{/* Inside your rows loop (range $note := ...) */}}
                <tr>
                  {{ range $col := $.Base.Columns }}
                    <td>
                      {{/* 1. CHECK: Is this the File Name column? */}}
                      {{ if eq $col "file.name" }}
                        {{/* Render a clickable link */}}
                        <a href="{{ $note.WebPath }}">{{ $note.Name }}</a>
                        {{/* 2. DEFAULT: Render any other column normally */}}
                      {{ else }}
                        {{ $val := getValue $.Site $note $col }}
                        {{ if $val }}{{ $val | safe }}{{ end }}
                      {{ end }}
                    </td>
                  {{ end }}
                </tr>
              {{ end }}
            {{ end }}
            {{/* CASE 2: FLAT VIEW */}}
          {{ else }}
            {{ range $note := .Base.Notes }}
              <tr>
                {{ range $col := $.Base.Columns }}
                  {{ $val := getValue $.Site $note $col }}
                  <td>{{ if $val }}{{ $val | safe }}{{ end }}</td>
                {{ end }}
              </tr>
            {{ end }}
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
{{ end }}
<!--  Cards -->
{{ define "cards" }}
  <div class="obsidian-view-container">
    {{/* CASE 1: GROUPED VIEW */}}
    {{ if .Base.Groups }}
      {{ range $group := .Base.Groups }}
        <div class="obsidian-group-container">
          <h3 class="group-header">
            {{ $group.Key }}
            <span class="group-count">({{ len $group.Notes }})</span>
          </h3>
          <div class="obsidian-cards-grid">
            {{ range $note := $group.Notes }}
              {{ template "card_item" (dict "Site" $.Site "Note" $note "Columns" $.Base.Columns) }}
            {{ end }}
          </div>
        </div>
      {{ end }}
      {{/* CASE 2: FLAT VIEW */}}
    {{ else }}
      <div class="obsidian-cards-grid">
        {{ range $note := .Base.Notes }}
          {{ template "card_item" (dict "Site" $.Site "Note" $note "Columns" $.Base.Columns) }}
        {{ end }}
      </div>
    {{ end }}
  </div>
{{ end }}
{{/* Helper Template for a Single Card */}}
{{ define "card_item" }}
  <div class="obsidian-card">
    {{/* Title is always the first visual element */}}
    <div class="card-title">
      <a href="{{ .Note.WebPath }}">{{ .Note.Name }}</a>
    </div>
    {{/* Loop through other columns (excluding file.name usually, but we show all for flexibility) */}}
    <div class="card-content">
      {{ range $col := .Columns }}
        {{/* Skip file.name if you want to avoid duplication, otherwise show all */}}
        {{ if ne $col "file.name" }}
          <div class="card-field">
            <span class="field-name">{{ $col }}:</span>
            <span class="field-value">
              {{ $val := getValue $.Site $.Note $col }}
              {{ if $val }}
                {{ $val | safe }}
              {{ else }}
                <span class="empty-value">-</span>
              {{ end }}
            </span>
          </div>
        {{ end }}
      {{ end }}
    </div>
  </div>
{{ end }}
<!-- List -->
{{ define "list" }}
  <div class="obsidian-view-container">
    {{ if .Base.Groups }}
      {{ range $group := .Base.Groups }}
        <div class="obsidian-group-container">
          <h3 class="group-header">
            {{ $group.Key }}
            <span class="group-count">({{ len $group.Notes }})</span>
          </h3>
          <ul class="obsidian-list">
            {{ range $note := $group.Notes }}
              {{ template "list_item" (dict "Site" $.Site "Note" $note "Columns" $.Base.Columns) }}
            {{ end }}
          </ul>
        </div>
      {{ end }}
    {{ else }}
      <ul class="obsidian-list">
        {{ range $note := .Base.Notes }}
          {{ template "list_item" (dict "Site" $.Site "Note" $note "Columns" $.Base.Columns) }}
        {{ end }}
      </ul>
    {{ end }}
  </div>
{{ end }}
{{/* Helper for List Item */}}
{{ define "list_item" }}
  <li class="obsidian-list-item">
    <div class="list-main">
      <a href="{{ .Note.WebPath }}" class="list-link">{{ .Note.Name }}</a>
    </div>
    {{/* Optional: Show other columns inline or below.
      For "List" view, usually we just show the name,
      but here is how to show extra fields as "badges" or subtitles
    */}}
    <div class="list-meta">
      {{ range $col := .Columns }}
        {{ if ne $col "file.name" }}
          {{ $val := getValue $.Site $.Note $col }}
          {{ if $val }}
            <span class="meta-tag">{{ $val | safe }}</span>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
  </li>
{{ end }}
<!-- Navbar -->
{{ define "tree" }}
  {{ range . }}
    <li>
      {{ if .IsFolder }}
        <details>
          <summary class="folder-name">
            <a
              href="{{ .Path }}"
              class="{{ if .Active }}active{{ end }} navbar-folder"
              >{{ .Name }}</a
            >
          </summary>
          <ul>
            {{ template "tree" .Children }}
          </ul>
        </details>
      {{ else }}
        <a
          href="{{ .Path }}"
          class="{{ if .Active }}active{{ end }} navbar-link"
          ><span>{{ .Name }}</span> {{ if .IsCanvas }}
            <span class="navbar-link-label">Canvas</span>
          {{ end }}{{ if .IsBase }}
            <span class="navbar-link-label">Base</span>
          {{ end }}</a
        >
      {{ end }}
    </li>
  {{ end }}
{{ end }}
{{ define "breadcrumbs" }}
  <nav class="breadcrumbs">
    {{ range $index, $element := .Breadcrumbs }}
      {{ if $index }}
        <span class="breadcrumb-separator">/</span>
      {{ end }}
      {{/* Check if URL exists. If it's the last item, you might want just text. */}}
      <a href="{{ $element.Url }}" class="breadcrumb-link"
        >{{ $element.Label }}</a
      >
    {{ end }}
  </nav>
{{ end }}
{{ define "folder" }}
  <div class="obsidian-view-container">
    <h1 class="view-title">Folder: {{ .Folder.Name }}</h1>
    <ul class="obsidian-list">
      {{/* 1. Sub-Folders */}}
      {{ range .Folder.Folders }}
        <li class="obsidian-list-item">
          <div class="list-main">
            {{/* Unicode icon for visual distinction */}}
            <span class="file-icon">üìÅ</span>
            <a href="{{ .WebPath }}" class="list-link folder-link"
              >{{ .Name }}</a
            >
          </div>
        </li>
      {{ end }}
      {{/* 2. Files */}}
      {{ range .Folder.Files }}
        <li class="obsidian-list-item">
          <div class="list-main">
            <span class="file-icon">üìÑ</span>
            <a href="{{ .WebPath }}" class="list-link">{{ .Name }}</a>
          </div>
          {{/* Metadata on the right side */}}
          <div class="list-meta">
            <span class="meta-tag" title="Last Modified"
              >{{ .Modified | formatDate }}</span
            >
          </div>
        </li>
      {{ end }}
    </ul>
  </div>
{{ end }}
{{ define "tag" }}
  <div class="obsidian-view-container">
    <h1 class="view-title">Tag: #{{ .Tag.Name }}</h1>
    <ul class="obsidian-list">
      {{ range .Tag.Files }}
        <li class="obsidian-list-item">
          <div class="list-main">
            <span class="file-icon">üìÑ</span>
            <a href="{{ .WebPath }}" class="list-link">{{ .Name }}</a>
          </div>
          <div class="list-meta">
            <span class="meta-tag" title="Last Modified"
              >{{ .Modified | formatDate }}</span
            >
          </div>
        </li>
      {{ end }}
    </ul>
  </div>
{{ end }}
